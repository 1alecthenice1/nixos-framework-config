name: Build NixOS Framework ISO

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  build-iso:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: DeterminateSystems/nix-installer-action@main
      with:
        extra-conf: |
          experimental-features = nix-command flakes
          allow-unfree = true
          access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
    
    - uses: DeterminateSystems/magic-nix-cache-action@main
    
    - name: Build ISO
      run: |
        nix build .#nixosConfigurations.framework-iso.config.system.build.isoImage
        
    - name: Get ISO info
      id: iso-info
      run: |
        ISO_PATH=$(find result -name "*.iso" | head -1)
        ISO_NAME=$(basename "$ISO_PATH")
        ISO_SIZE=$(du -h "$ISO_PATH" | cut -f1)
        echo "path=$ISO_PATH" >> $GITHUB_OUTPUT
        echo "name=$ISO_NAME" >> $GITHUB_OUTPUT
        echo "size=$ISO_SIZE" >> $GITHUB_OUTPUT
        
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: nixos-framework-iso
        path: ${{ steps.iso-info.outputs.path }}
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ${{ steps.iso-info.outputs.path }}
        body: |
          # Framework NixOS ${{ github.ref_name }}
          
          **ISO Information:**
          - Name: `${{ steps.iso-info.outputs.name }}`
          - Size: ${{ steps.iso-info.outputs.size }}
          - Target: Framework Laptop 13 AMD 7040
          
          **Features:**
          - Framework hardware optimizations
          - TPM 2.0 + LUKS encryption support
          - Secure Boot ready (lanzaboote)
          - Hyprland desktop environment
          - 64GB RAM optimized configuration
          
          **Installation:**
          1. Flash to USB drive
          2. Boot on Framework laptop
          3. Follow installation guide in repository
